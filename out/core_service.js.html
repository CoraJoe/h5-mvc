<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Gom.html">Gom</a></li><li><a href="Gom.App.html">App</a></li><li><a href="Gom.Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Gom.Page.html#destory">destory</a></li><li data-type='method'><a href="Gom.Page.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.Page.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.Page.html#render">render</a></li><li data-type='method'><a href="Gom.Page.html#show">show</a></li><li data-type='method'><a href="Gom.Page.html#update">update</a></li></ul></li><li><a href="Gom.Service.html">Service</a></li><li><a href="Gom.UI.html">UI</a></li><li><a href="Gom.UI.Button.html">Button</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Button.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Button.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Button.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Button.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Button.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Button.html#update">update</a></li></ul></li><li><a href="Gom.UI.Header.html">Header</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Header.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Header.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Header.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Header.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Header.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Header.html#update">update</a></li></ul></li><li><a href="Gom.UI.List.html">List</a><ul class='methods'><li data-type='method'><a href="Gom.UI.List.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.List.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.List.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.List.html#render">render</a></li><li data-type='method'><a href="Gom.UI.List.html#show">show</a></li><li data-type='method'><a href="Gom.UI.List.html#update">update</a></li></ul></li><li><a href="Gom.UI.Modal.html">Modal</a></li><li><a href="Gom.UI.Scroll.html">Scroll</a></li><li><a href="Gom.UI.Select.html">Select</a></li><li><a href="Gom.UI.Slide.html">Slide</a></li><li><a href="Gom.UI.Toggle.html">Toggle</a></li><li><a href="Gom.View.html">View</a></li><li><a href="Sides.html">Sides</a></li></ul><h3>Namespaces</h3><ul><li><a href="store.html">store</a><ul class='methods'><li data-type='method'><a href="store.html#.del">del</a></li><li data-type='method'><a href="store.html#.del">del</a></li><li data-type='method'><a href="store.html#.each">each</a></li><li data-type='method'><a href="store.html#.get">get</a></li><li data-type='method'><a href="store.html#.has">has</a></li><li data-type='method'><a href="store.html#.noexpire">noexpire</a></li><li data-type='method'><a href="store.html#.size">size</a></li></ul></li><li><a href="url.html">url</a><ul class='methods'><li data-type='method'><a href="url.html#.getHashPath">getHashPath</a></li><li data-type='method'><a href="url.html#.getHashSearch">getHashSearch</a></li><li data-type='method'><a href="url.html#.getHTML5Hash">getHTML5Hash</a></li><li data-type='method'><a href="url.html#.getParams">getParams</a></li><li data-type='method'><a href="url.html#.getUrl">getUrl</a></li><li data-type='method'><a href="url.html#.set">set</a></li><li data-type='method'><a href="url.html#.setParam">setParam</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#_parseEvent">_parseEvent</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#events">events</a></li><li><a href="global.html#isback">isback</a></li><li><a href="global.html#isTopBot">isTopBot</a></li><li><a href="global.html#offview">offview</a></li><li><a href="global.html#onview">onview</a></li><li><a href="global.html#params">params</a></li><li><a href="global.html#refreshEvent">refreshEvent</a></li><li><a href="global.html#requirejs">requirejs</a></li><li><a href="global.html#seo">seo</a></li><li><a href="global.html#slideInModal">slideInModal</a></li><li><a href="global.html#title">title</a></li><li><a href="global.html#tmpl">tmpl</a></li><li><a href="global.html#toUrl">toUrl</a></li><li><a href="global.html#widgets">widgets</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define(['Modal'], function(Modal){
    var loading;
    //要达到的设定有：
    //支持实际场景不跨域开发跨域时的配置 devCrossDomain: true(CROS)
    //支持 jsonp与ajax的一键切换开发模式，当模式变化时，前端可以快速反应
    //支持 header, data, cookie相关数据传输
    //支持 ajax injector， 在ajax request与response处可以统一处理。

    //默认Ajax截击器
    var defaultInject = {
        request: function(e, xhr, options){
            //console.log(e, xhr, options, 'default request inject');
        },
        response: function(e, xhr, options){
            //console.log(e, xhr, options, 'default response inject');
        }
    };

    //从外部自定义Ajax截击器
    var modelInject = $.extend({}, defaultInject);
    //如果有外部Ajax截击器则均触发，否则仅触发默认;
    var inject = function(req, res){
        modelInject.request = function(e, xhr, options){
            defaultInject.request(e, xhr, options);
            var defreq = req(e, xhr, options);
            if(defreq === false) return false;   //自定义的req return false时阻止ajax请求
        };

        modelInject.response = function(e, xhr, options){
            defaultInject.response(e, xhr, options);
            res(e, xhr, options);
        };
    };

    //全局处理
    $.ajaxSettings.timeout = 1000 * 60; //默认超时时间为1分钟
    $.ajaxSettings.error = function(xhr, errorType) {
        if (errorType === 'timeout') {
            Modal.toast('信号偏弱，访问超时', 'error');
        } else if (errorType === 'error') {
            var statusCode = xhr.status;
            if (statusCode === 404 || statusCode === 500) {   //处理状态码错误
                //window.location.href = '?' + statusCode;
            }
        }
    };

    $(document).on('ajaxBeforeSend', function(e, xhr, options){
        loading = Modal.loading();
        var req = modelInject.request(e, xhr, options);
        if(req === false) return false;  //阻击发出请求
    }).on('ajaxComplete', function(e, xhr, options){
        loading.toggleModal('Out');
        modelInject.response(e, xhr, options);
    });

    /**
     * Model分构造函数与方式调用二种调用，
     * 其用处为构造函数时用于构造Modal的ajax封装，用法为 new Model({url: '//example.com/getList?id=123'});
     * 为方式时作为ajax拦截注入器注入request与response, 用法为 new Model({req:function(){}, res: function(){}});
     * @class Gom.Service
     * @alias Service
     * @param {object} opts 参列或 opts.req, opts.res
     * @examle Service ajax注入器操作，对request,response统一处理。
        new Service({
            req:function(e, xhr, options){
                console.log(e, xhr, options, 'def request inject');
                if(!!~options.url.indexOf('http://xproduct.ctrip.me:3003')) return false;   //return false时拦截ajax发出请求发现
            },
            res: function(e, xhr, options){
                console.log(e, xhr, options, 'def response inject');
            }
        });
        //Service ajax操作
        var listModel = new Service({
            url: 'http://xproduct.ctrip.me:3003/api/mall/receipts'
        });
        listModel.fetch({userId:123}).done(function(data){
            console.log(data, 'data');
        });
     *
     *
     *
     *
     */
    var Service = Class.extend({
        init: function(opts){
            //如果为注入器，仅执行注入操作，不实例化Service;
            if(opts.req || opts.res){
                inject(opts.req, opts.res);
                return;
            }
            this.url = opts.url;
        },
        /**
         * 一般用于post保存数据
         * @method service#save
         * @param {object} params 保存的数据
         * @return promise
         */
        save: function(params){
            return this.ajax(params, {type: 'POST'});
        },
        /**
         * 一般用于get获取数据
         * @method service#fetch
         * @param {object|*} ids id集合或id等
         * @return promise
         */
        fetch: function(ids){
            return this.ajax(ids);
        },
        /**
         * 同步获取本地模板
         */
        tmpl: function(){
            return this.ajax({dataType:'html', async: false})
        },
        /**
         *@method service#get
         * @see  http://zeptojs.com/#$.get
         */
        get: $.get,
        /**
         * @method service#post
         * @see  http://zeptojs.com/#$.post
         */
        post: $.post,
        /**
         * @private
         * @see  http://zeptojs.com/#ajax
         */
        ajax: function(data, opts){
            var ajaxOpts = {}, opts = opts || {};
            if(opts.withCredentials){
                ajaxOpts.xhrFields = {
                    withCredentials: true
                };
            }
            $.extend(ajaxOpts, opts,  {
                url: this.url,
                data: data,
                dataType: opts.dataType || 'json', //json, jsonp, script, xml, html, or text.
                //headers: opts.headers || {}, //自定义请求会触发预请求
                //async: opts.async || true,    //默认异步
                //crossDomain: true,
                //timeout: 300,
            });

            return $.ajax(ajaxOpts);
        }
    });

    return Service;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Sun Dec 13 2015 23:01:03 GMT+0800 (CST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
